# 支付
## 流程
### 客户端支付同步通知
1. 调用后端API（检查，更新订单），返回支付结果
1. 将API返回的结果告知用户

## 支付宝
* [app支付流程](https://doc.open.alipay.com/docs/doc.htm?spm=a219a.7629140.0.0.4tRhKq&treeId=193&articleId=105297&docType=1)

## 微信
* [app支付流程](https://pay.weixin.qq.com/wiki/doc/api/app/app.php?chapter=8_3)
* [统一下单API](https://pay.weixin.qq.com/wiki/doc/api/app/app.php?chapter=9_1)

### prepay（2b设计）解决方案
1. 2小时有效，如果支付时间少于2小时，可以存在订单上
1. [再次付款的解决方案](http://blog.csdn.net/xb12369/article/details/50587939)

# 系统内代付
## 产品设计
1. 支持一个订单只有1个代付单（代付单和订单支付超时时间一致）。
1. 如果代付发起后，请求方还可以发起微信或支付宝支付，同时，代付单会失效。
1. 退款只能退款到支付账户中。
1. 支付单的类型支持系统内代付。
1. 代付单在“我的”里面，进入后可代付。

## 系统设计
* 代付单结构(BehalfPayOrder)：请求方，代付方，代付金额，代付说明，请求方支付单，请求方订单号，代付方支付单，过期时间。
* 所需支持的表结构：请求方支付单(b)，代付方支付单(p)，代付单(df)，请求方退款单(br)，代付方退款单(pr)。
* 通过df能单向找到b和p，因为df是扩展功能。保证系统解耦。

## 流程
1. 发起代付：生成df(设置请求方订单号等)。
1. 代付去支付：无操作
1. 代付成功：生成b和p (状态都是支付成功)，修改df(状态是完成, b和p的id)
1. 代付退款：正常退款流程(生成br和pr，修改订单状态)。
1. 发起后再自己支付：关闭df。
