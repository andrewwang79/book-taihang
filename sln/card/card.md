# 资金账户/卡系统

* 资金账户系统，拥有支付密码
* 卡系统，一个资金账户可以有多张卡
* [安全风控](../finance/design.html)

# 卡系统

| 功能 | 优先级 | 输入 | 系统开发 |
| :----: | ---- | ---- |
| 开户，审核，激活 | 高 | 卡号 | 开卡 |
| 重置密码 | 高 | 卡号，老密码(可选)，新密码 |  |
| 注销 | 中 | 卡号 |  |
| 冻结/解冻 | 中 | 卡号 | 锁定的卡无法进行交易，比如密码输错3次 |
| 挂失/解挂 | 中 | 卡号 | 挂失的卡无法进行交易 |
| 获取卡信息(状态) | 高 | 卡号 | 不需要密码 |
| 余额查询 | 高 |  | 不需要密码 |
| 充值 | 高 |  | 充值风险？ |
| 消费(线上/线下) | 高 |  | 外部订单号 |
| 退款(线上/线下) | 高 |  |  |
| 交易明细(状态等，含退款) | 高 | 外部订单号 |  |
| 交易列表查询 | 中 | 时间，类型，渠道(线上线下等)等 | 商户号，终端号，卡号，外部订单号。可区分退款等各种类型 |
| 转账 | 低 | 两个卡号 |  |
| 交易实时推送 | 中 |  | 只推送一次，要有确保机制 |
| 线上消费的多次部分退款 | 低 |  |  |
| 充值总金额查询 | 低 | 商户号，终端号，卡号；时间范围 |  |
| 加密机秘钥管理 | 低 |  |  |
| 额度配置(单次消费，单日消费等) | 低 |  |  |
| 可疑交易管理 | 低 |  | 可推送 |

# 资金账户系统
## 方案
1. 公司是卡系统的一个商户号
1. 实体店不能使用实体卡(原因是pos数据无法和业务系统对接，否则可以使用)
1. 尽量不用pos机
2. 旧卡不退款

## 流程
### 开卡
#### 绑卡（实卡）
1. 主流程

```

if (用户不存在) {
  跳转到 注册用户
} else {
  if (用户未绑定卡)
    用户未绑定卡流程
  else
    用户已绑定卡流程
}

```

2. 用户未绑定卡

```

if (手机验证码认证失败)
 return 提示验证码错误

开卡(卡号，用户号，支付密码)//调中付接口开卡
if (开卡成功)
  用户账号关联这张卡//后端数据库保存关联
  绑卡成功
else
  return 提示开卡失败

```

3. 用户已绑定卡(新卡必须是实体卡)
1.转账失败、旧卡注销失败后到最终成功之间的处理?

```

if (手机验证码认证失败)
  return 提示验证码错误

if (会员卡状态 != 有效)
  return 提示会员卡状态异常

if (!用户同意迁移) {
  msg = 提示已经绑卡 (旧卡不退款，余额3日内到账)
  return msg
}

开新卡(卡号，用户号，支付密码)//调中付接口开卡
if (开新卡成功){
  用户账号关联新卡//后端数据库保存关联
  注销旧卡//调中付接口改变卡状态为失效
   if (注销成功){
    生成卡状态改变成功的记录
  } else {
    生成卡状态改变失败的记录
  }
  充值新卡//充值金额为旧卡余额
  if (充值成功){
      绑卡成功
  } else {
      生成充值失败记录
  }

} else {
  return 提示开卡失败
}

```

#### 绑卡（虚拟卡）：

```

if (用户已经绑卡)
  return 提示已经绑卡(虚拟卡无法再次绑卡)

if (手机验证码认证失败)
  return 提示验证码错误

开卡(卡池内随机卡号，用户号，支付密码)//调中付接口开卡
if (开卡成功){
  用户账号关联这张卡//后端数据库保存关联
  绑卡成功
} else {
  return 提示开卡失败
}

```

### 挂失
#### 门店：[不支持]
#### 线上：
1.先中付还是先后端数据库

```

if (手机验证码认证失败)
  return 提示验证码错误

if (会员卡状态 != 有效){
  return 提示会员卡状态异常
}

调中付接口改变会员卡状态为冻结//先中付挂失
if (改变状态成功){
  挂失成功
} else{
  return 提示挂失失败
}

```

### 解挂
#### 门店：[不支持]
#### 线上：

```

if (手机验证码认证失败)
  return 提示验证码错误

if (会员卡状态 != 冻结){
  return 提示会员卡状态异常
}

调中付接口改变会员卡状态为有效//先中付解挂
if (改变状态成功){
  解挂成功
} else{
  return 提示解挂失败
}

```

### 充值
#### 门店：[不支持]
#### 门店预付费卡充值：预付费卡扣款，通过收银助手充值。操作风险怎么办？（暂停）
#### 线上：

1.支付成功，充值失败的处理

```

if (会员卡状态 != 有效)
  return 提示会员卡状态异常

支付单生成(金额,支付方式)并支付//先生成订单，获取订单码支付
if (支付成功){
  充值入会员卡//中付充值
  if (充值成功)
    充值成功
  else
    人工处理
} else {
  return 提示支付失败
}

```

### 支付
#### 线上：

```
if (会员卡状态 != 有效)
  return 提示会员卡状态异常

支付(支付类型会员卡支付，支付单号，支付密码)//中付支付

```

#### 门店
1.如何扫会员的支付码
2.营业员没按操作要求输入流水号


* 收银助手支付

```

营业员操作收银系统生成订单
//必须先输入金额再扫码获取会员卡信息
收银助手获得消费金额，会员卡信息

if (会员卡没绑定 || 会员卡状态 != 有效 || 会员卡余额 < 支付金额) // 无效或金额不够
  return 提示会员卡相应问题

支付单生成(金额,卡号)//根据金额和卡号生成支付单

//用户手机在会员卡界面弹出支付密码输入框,支付调用中付支付
用户手机输入支付密码并支付

if (支付成功)
  收银系统绑定订单(支付单流水号) //获取支付单流水号
else
  return 提示支付失败

```

* 收银系统绑定订单

```

 获取支付单流水号
  //必须按照先输入备注再选择支付方式完成收银这个顺序
  收银员将流水号输入收银系统生成的订单备注
  收银员选择会员卡支付方式，并完成收银

```

### 退款
#### 门店：
1.收银系统备注中没有流水号

```
if (收银系统获取备注中该单流水号)
  收银助手用流水号查询该支付记录//从后端数据库查询记录
else
???

if (支付记录获取失败)
  return 提示没有支付记录

if (该支付记录所使用的会员卡状态 != 有效)
  return 提示会员卡状态异常

退款(金额、流水号)//收银助手根据金额和流水号进行退款
if (退款成功)
  收银系统人工确认退款
else
  return 提示退款失败

```

#### 线上：

```
订单退货

if (该订单所使用的会员卡状态 != 有效)
 return 提示会员卡状态异常

退款(金额，订单号)//根据金额和订单号进行退款

```

### 托管账户管理
1. 线上/线下充值的资金账户托管：人工操作T+1到托管账户
